---
name: "CI/CD – Train → Build/Test → Push → Render Deploy"

"on":
  push:
    branches:
      - main
  workflow_dispatch: {}

permissions:
  contents: read
  packages: write   # needed for GHCR
  actions: read

env:
  IMAGE_NAME: ghcr.io/rawad-yared/telco-churn-mlops
  TAG_SHA: ${{ github.sha }}

jobs:
  train:
    name: Train model on full dataset
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: "Smoke: compile sources"
        run: |
          python -m compileall src app

      - name: Load & train on real Excel
        run: |
          ls -l data/raw
          python -m src.data.load_data
          python -m src.models.train_model
          ls -l models

      - name: Upload trained model artifact
        uses: actions/upload-artifact@v4
        with:
          name: trained-model
          path: models/best_model_*.joblib
          retention-days: 7

  build_test_push:
    name: Build image, run health-check, push to GHCR
    needs: train
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Download trained model
        uses: actions/download-artifact@v4
        with:
          name: trained-model
          path: models

      - name: Verify model present
        run: ls -l models

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build Docker image
        run: |
          IMAGE_LC=$(echo "${{ env.IMAGE_NAME }}" | tr '[:upper:]' '[:lower:]')
          docker build -t $IMAGE_LC:latest -t $IMAGE_LC:${{ env.TAG_SHA::7 }} .
          echo "IMAGE_LC=$IMAGE_LC" >> $GITHUB_ENV

      - name: Run container & health-check
        run: |
          docker run -d -p 8000:8000 --name telco-api $IMAGE_LC:latest
          sleep 10
          curl -f http://localhost:8000/health
          curl -s -X POST http://localhost:8000/predict \
            -H "Content-Type: application/json" \
            -d '{"data":{"Contract":"Month-to-month", \
            "Internet Service":"Fiber optic", \
            "Monthly Charges":80,"Tenure Months":5}}' \
            | tee /tmp/predict.json
          docker logs telco-api || true
          docker stop telco-api && docker rm telco-api

      - name: Push image to GHCR
        run: |
          docker push $IMAGE_LC:latest
          docker push $IMAGE_LC:${{ env.TAG_SHA::7 }}

  deploy_render:
    name: Trigger Render deploy
    needs: build_test_push
    if: ${{ github.ref == 'refs/heads/main' }}
    runs-on: ubuntu-latest
    steps:
      - name: Call Render Deploy API
        run: |
          RENDER_BASE="https://api.render.com/v1/services/"
          RENDER_URL="${RENDER_BASE}${{ secrets.RENDER_SERVICE_ID }}/deploys"
          curl -X POST \
            -H "Accept: application/json" \
            -H "Authorization: Bearer ${{ secrets.RENDER_API_KEY }}" \
            "$RENDER_URL"
