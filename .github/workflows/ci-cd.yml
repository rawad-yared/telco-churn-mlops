---
name: "CI/CD - Train -> Build/Test -> Push -> Render"
"on":
  push:
    branches:
      - main
  workflow_dispatch: {}

permissions:
  contents: read
  packages: write
  actions: read

env:
  IMAGE_NAME: ghcr.io/${{ github.repository }}

jobs:
  train:
    name: "Train model"
    runs-on: ubuntu-latest
    steps:
      - name: "Checkout"
        uses: actions/checkout@v4

      - name: "Set up Python"
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: "Cache pip"
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: "Install deps"
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: "Compile sources"
        run: python -m compileall src app

      - name: "Train on Excel"
        run: |
          ls -l data/raw
          python -m src.data.load_data
          python -m src.models.train_model
          ls -l models

      - name: "Upload model"
        uses: actions/upload-artifact@v4
        with:
          name: trained-model
          path: models/best_model_*.joblib
          retention-days: 7

  build_test_push:
    name: "Build and push image"
    needs: train
    runs-on: ubuntu-latest
    steps:
      - name: "Checkout"
        uses: actions/checkout@v4

      - name: "Download model"
        uses: actions/download-artifact@v4
        with:
          name: trained-model
          path: models

      - name: "Verify model"
        run: ls -l models

      - name: "Login to GHCR"
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: "Build image"
        shell: bash
        run: |
          IMAGE_LC=$(echo "${{ env.IMAGE_NAME }}" \
            | tr '[:upper:]' '[:lower:]')
          SHORT_SHA=${GITHUB_SHA::7}
          echo "IMAGE_LC=$IMAGE_LC" >> "$GITHUB_ENV"
          echo "SHORT_SHA=$SHORT_SHA" >> "$GITHUB_ENV"
          docker build -t "$IMAGE_LC:latest" \
            -t "$IMAGE_LC:$SHORT_SHA" .

      - name: "Health check"
        shell: bash
        run: |
          docker run -d -p 8000:8000 --name telco "$IMAGE_LC:latest"
          sleep 10
          curl -f http://localhost:8000/health
          printf '%s\n' '{' '"data": {' \
            '"Contract": "Month-to-month",' \
            '"Internet Service": "Fiber optic",' \
            '"Monthly Charges": 80,' \
            '"Tenure Months": 5' '}' '}' > body.json
          curl -s -X POST http://localhost:8000/predict \
            -H "Content-Type: application/json" \
            -d @body.json > /tmp/predict.json
          docker logs telco || true
          docker stop telco && docker rm telco

      - name: "Push image"
        shell: bash
        run: |
          docker push "$IMAGE_LC:latest"
          docker push "$IMAGE_LC:$SHORT_SHA"

  deploy_render:
    name: "Deploy to Render"
    needs: build_test_push
    if: ${{ github.ref == 'refs/heads/main' }}
    runs-on: ubuntu-latest
    steps:
      - name: Trigger Render Deploy-fastapi
        run: |
          API_URL="https://api.render.com/v1/services"
          AUTH="Authorization: Bearer ${{ secrets.RENDER_API_KEY }}"

          curl -X POST -H "Accept: application/json" \
            -H "$AUTH" "$API_URL/${{ secrets.RENDER_SERVICE_ID}}/deploys"

      - name: Trigger Render Deploy-streamlit
        run: |
          API_URL="https://api.render.com/v1/services"
          AUTH="Authorization: Bearer ${{ secrets.RENDER_API_KEY }}"

          curl -X POST -H "Accept: application/json" \
            -H "$AUTH" "$API_URL/${{ secrets.RENDER_STREAMLIT_SERVICE_ID}}/deploys"
